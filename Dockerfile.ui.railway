FROM python:3.11-slim-bookworm as requirements-stage

WORKDIR /tmp
RUN pip install poetry
RUN poetry self add poetry-plugin-export
COPY ./pyproject.toml /tmp/pyproject.toml
COPY ./poetry.lock /tmp/poetry.lock
RUN poetry export -f requirements.txt --output requirements.txt --without-hashes

FROM python:3.11-slim-bookworm

# Set environment variables for Railway
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONPATH="/app:$PYTHONPATH"

# Railway-specific environment variables for UI
ENV PORT=8080
ENV VITE_API_BASE_URL="https://skyvern-production-5271.up.railway.app/api/v1"
ENV VITE_WSS_BASE_URL="wss://skyvern-production-5271.up.railway.app/api/v1"

WORKDIR /app

# Install system dependencies (minimal for UI)
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY --from=requirements-stage /tmp/requirements.txt /app/requirements.txt
RUN pip install --upgrade pip setuptools wheel
RUN pip install --no-cache-dir --upgrade -r requirements.txt

# Copy application code
COPY . /app

# Create necessary directories
RUN mkdir -p /app/.streamlit

# Copy and set up entrypoint for UI
COPY ./entrypoint-ui-railway.sh /app/entrypoint-ui-railway.sh
RUN chmod +x /app/entrypoint-ui-railway.sh

# Expose port for Railway
EXPOSE $PORT

CMD ["/app/entrypoint-ui-railway.sh"] 